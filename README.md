# 邮件识别与分拣系统

## 项目简介
本项目是一个基于YOLOv8目标检测和条形码识别的邮件处理系统，能够实时识别摄像头中的邮件相关物体（如黑块、条形码、信件等），解析条形码包含的地区信息，并通过串口将识别结果发送至外部设备（如主控系统），适用于自动化邮件分拣场景。


## 功能特点
1. **实时目标检测**：使用YOLOv8模型（ONNX格式）实时检测图像中的目标（支持自定义类别）。
2. **条形码识别**：通过`pyzbar`库解析图像中的条形码数据，映射至对应地区名称。
3. **串口通信**：自动识别CH340/USB串口设备，将检测结果（目标类别、坐标等）格式化发送至外部设备。
4. **实时可视化**：通过OpenCV实时显示检测结果，包括边界框、类别标签和条形码信息。
5. **参数可配置**：支持通过命令行调整模型路径、置信度阈值、交并比（IoU）阈值等参数。


## 环境依赖
- Python 3.7+
- 依赖库：
  ```
  opencv-python==4.8.0
  numpy==1.24.3
  onnxruntime==1.15.0  # 支持CPU/CUDA推理
  torch==2.0.0  # 用于CUDA可用性判断
  pyserial==3.5
  pyzbar==0.1.9
  argparse==1.4.0
  ```


## 安装步骤
1. **克隆项目**（若有仓库）：
   ```bash
   git clone <项目仓库地址>
   cd <项目目录>
   ```

2. **安装依赖**：
   ```bash
   pip install -r requirements.txt
   # 若需CUDA加速，确保安装对应版本的onnxruntime-gpu
   # pip install onnxruntime-gpu==1.15.0
   ```

3. **准备模型文件**：
   - 将YOLOv8的ONNX模型文件（默认名为`youjian2.onnx`）放在项目根目录，或通过命令行指定路径。

4. **配置条形码映射文件**：
   - 创建`识别地址码.txt`，格式为`条形码:地区名称`（例如：`123456:华中地区`），并存放在指定路径（代码中默认路径为`F:\比赛\邮件识别\`，需根据实际情况修改）。


## 使用方法
1. **连接硬件**：
   - 确保摄像头（默认使用索引为1的摄像头）和串口设备（如CH340模块）正确连接。

2. **运行程序**：
   ```bash
   python 邮件测试.py [--model 模型路径] [--conf-thres 置信度阈值] [--iou-thres IoU阈值]
   ```

   **示例**：
   ```bash
   python 邮件测试.py --model ./yolov8.onnx --conf-thres 0.6 --iou-thres 0.7
   ```

3. **操作说明**：
   - 程序启动后自动打开摄像头，实时显示检测画面。
   - 检测到目标或条形码时，会在画面中绘制边界框和标签。
   - 按`A`键退出程序。


## 参数说明
| 参数名       | 类型   | 默认值         | 说明                     |
|--------------|--------|----------------|--------------------------|
| --model      | str    | "youjian2.onnx" | YOLOv8的ONNX模型路径     |
| --conf-thres | float  | 0.5            | 目标检测的置信度阈值     |
| --iou-thres  | float  | 0.8            | 非极大抑制（NMS）的IoU阈值 |


## 配置说明
1. **摄像头设置**：
   - 代码中默认使用`cv2.VideoCapture(1)`，若摄像头索引不符，可修改为`0`或其他索引。
   - 分辨率默认设置为640x480，可通过`cap.set()`调整。

2. **串口配置**：
   - 程序自动识别含`CH340`或`USB`标识的串口，波特率固定为115200。
   - 若串口连接失败，检查设备驱动或修改`serial_init()`函数中的串口筛选条件。

3. **类别定义**：
   - 目标类别在`Classes`字典中定义（默认：`{0:"black",1:"bar code",2:"letter"}`），可根据模型训练类别修改。
   - 地区ID映射在`class_mapping`中定义（如`0:"huazhong"`对应华中地区）。


## 数据格式
串口发送的数据格式如下：
- **目标检测结果**：`AB:class_id,x,y,w,h:#`  
  其中`class_id`为类别ID，`(x,y)`为目标中心坐标，`w,h`为宽高。
- **类别映射信息**：`CD:id:name;...##`  
  用于告知外部设备类别ID与名称的对应关系。


## 注意事项
1. 确保`识别地址码.txt`路径正确，否则会提示文件未找到错误。
2. 若使用CUDA加速，需安装对应版本的`onnxruntime-gpu`并确保GPU驱动正常。
3. 条形码识别依赖清晰的图像质量，避免模糊或遮挡。
4. 串口设备需提前安装驱动，否则可能无法识别。


## 常见问题
- **摄像头无法打开**：检查摄像头索引是否正确，或被其他程序占用。
- **模型推理缓慢**：尝试降低分辨率、提高置信度阈值，或使用CUDA加速。
- **串口无数据发送**：检查串口设备连接，确保`serial_init()`函数正确识别设备。
